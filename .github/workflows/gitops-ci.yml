name: GitOps CI - Build & Push to ECR + Update Helm

on:
  push:
    branches: [ "gitops" ]

permissions:
  id-token: write   # required for OIDC
  contents: write   # required to commit updated values.yaml

jobs:
  build-push-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to ECR
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}"

          IMAGE_TAG="${GITHUB_SHA}"
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

          docker build -t "${ECR_URI}:${IMAGE_TAG}" .
          docker push "${ECR_URI}:${IMAGE_TAG}"

      - name: Update Helm values.yaml with new image repo/tag
        env:
          VALUES_FILE: ${{ vars.HELM_VALUES_FILE }}
        run: |
          # Update image.repository and image.tag in values.yaml (simple yq-less approach)
          # Assumes keys exist exactly as:
          # image:
          #   repository: ""
          #   tag: ""
          sed -i.bak "s|^\(\s*repository:\s*\).*|\1\"${ECR_URI}\"|g" "$VALUES_FILE"
          sed -i.bak "s|^\(\s*tag:\s*\).*|\1\"${IMAGE_TAG}\"|g" "$VALUES_FILE"
          rm -f "${VALUES_FILE}.bak"

          git status
          git diff

      - name: Commit and push updated values.yaml
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add ${{ vars.HELM_VALUES_FILE }}
          git commit -m "chore(gitops): deploy ${GITHUB_SHA}" || echo "No changes to commit"
          git push
          
      - name: Verify AWS identity
        run: aws sts get-caller-identity
